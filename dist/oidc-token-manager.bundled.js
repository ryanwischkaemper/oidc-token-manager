System.register("src/FrameLoader.ts",["npm:systemjs-plugin-babel@0.0.6/babel-helpers/classCallCheck.js","npm:systemjs-plugin-babel@0.0.6/babel-helpers/createClass.js"],function($__export){"use strict";var _classCallCheck,_createClass,FrameLoader;return{setters:[function($__m){_classCallCheck=$__m["default"]},function($__m){_createClass=$__m["default"]}],execute:function(){FrameLoader=function(){function FrameLoader(url,configObj){_classCallCheck(this,FrameLoader),this.url=url,this.config=configObj||{},this.config.cancelDelay=this.config.cancelDelay||5e3}return _createClass(FrameLoader,[{key:"loadAsync",value:function(url){var _this=this;return url=url||this.url,url?new Promise(function(resolve,reject){var frame=window.document.createElement("iframe");frame.style.display="none";var handle=window.setTimeout(cancel,_this.config.cancelDelay);window.addEventListener("message",message,!1),window.document.body.appendChild(frame),frame.src=url;var cleanup=function(){window.removeEventListener("message",message,!1),handle&&window.clearTimeout(handle),handle=null,window.document.body.removeChild(frame)},cancel=function(e){cleanup(),reject()},message=function(e){handle&&e.origin===location.protocol+"//"+location.host&&e.source==frame.contentWindow&&(cleanup(),resolve(e.data))}}):Promise.reject(new Error("no url provided"))}}]),FrameLoader}(),$__export("FrameLoader",FrameLoader)}}}),System.register("src/Utils.ts",["npm:systemjs-plugin-babel@0.0.6/babel-helpers/classCallCheck.js","npm:systemjs-plugin-babel@0.0.6/babel-helpers/createClass.js"],function($__export){"use strict";var _classCallCheck,_createClass,Utils;return{setters:[function($__m){_classCallCheck=$__m["default"]},function($__m){_createClass=$__m["default"]}],execute:function(){Utils=function(){function Utils(){_classCallCheck(this,Utils)}return _createClass(Utils,null,[{key:"copy",value:function(obj,target){target=target||{};for(var key in obj)obj.hasOwnProperty(key)&&(target[key]=obj[key]);return target}}]),Utils}(),$__export("Utils",Utils)}}}),System.register("src/OidcClient.ts",["npm:systemjs-plugin-babel@0.0.6/babel-helpers/classCallCheck.js","npm:systemjs-plugin-babel@0.0.6/babel-helpers/createClass.js"],function($__export){"use strict";var _classCallCheck,_createClass,OidcClient;return{setters:[function($__m){_classCallCheck=$__m["default"]},function($__m){_createClass=$__m["default"]}],execute:function(){OidcClient=function(){function OidcClient(settings){_classCallCheck(this,OidcClient)}return _createClass(OidcClient,[{key:"createTokenRequestAsync",value:function(){return Promise.resolve()}},{key:"createLogoutRequestAsync",value:function(idToken){return Promise.resolve()}},{key:"processResponseAsync",value:function(queryString){return Promise.resolve()}}],[{key:"parseOidcResult",value:function(hash){return hash}}]),OidcClient}(),$__export("OidcClient",OidcClient)}}}),System.registerDynamic("github:frankwallis/plugin-typescript@4.0.1.json",[],!1,function(){return{main:"plugin",format:"register"}}),System.register("npm:systemjs-plugin-babel@0.0.6/babel-helpers/classCallCheck.js",[],function($__export){"use strict";return{setters:[],execute:function(){$__export("default",function(instance,Constructor){if(!(instance instanceof Constructor))throw new TypeError("Cannot call a class as a function")})}}}),System.registerDynamic("npm:systemjs-plugin-babel@0.0.6.json",[],!1,function(){return{main:"plugin-babel.js",map:{"systemjs-babel-build":{browser:"./systemjs-babel-browser.js"}},meta:{"./plugin-babel.js":{format:"cjs"}}}}),System.register("npm:systemjs-plugin-babel@0.0.6/babel-helpers/createClass.js",[],function($__export){"use strict";function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||!1,descriptor.configurable=!0,"value"in descriptor&&(descriptor.writable=!0),Object.defineProperty(target,descriptor.key,descriptor)}}return{setters:[],execute:function(){$__export("default",function(Constructor,protoProps,staticProps){return protoProps&&defineProperties(Constructor.prototype,protoProps),staticProps&&defineProperties(Constructor,staticProps),Constructor})}}}),System.register("src/Token.ts",["npm:systemjs-plugin-babel@0.0.6/babel-helpers/classCallCheck.js","npm:systemjs-plugin-babel@0.0.6/babel-helpers/createClass.js"],function($__export){"use strict";var _classCallCheck,_createClass,Token;return{setters:[function($__m){_classCallCheck=$__m["default"]},function($__m){_createClass=$__m["default"]}],execute:function(){Token=function(){function Token(other){if(_classCallCheck(this,Token),this.other=other,this.other||(this.expires_at=0),this.profile=other.profile,this.id_token=other.id_token,this.access_token=other.access_token,other.access_token)this.expires_at=parseInt(other.expires_at);else{if(!other.id_token)throw Error("Either access_token or id_token required.");this.expires_at=other.profile.exp}this.scope=other.scope,this.session_state=other.session_state}return _createClass(Token,[{key:"toJSON",value:function(){return JSON.stringify({profile:this.profile,id_token:this.id_token,access_token:this.access_token,expires_at:this.expires_at,scope:this.scopes.join(" "),session_state:this.session_state})}},{key:"scopes",get:function(){return(this.scope||"").split(" ")}},{key:"expired",get:function(){var n=Date.now()/1e3,now=parseInt(n.toString());return this.expires_at<now}},{key:"expires_in",get:function(){var n=Date.now()/1e3,now=parseInt(n.toString());return this.expires_at-now}}],[{key:"fromResponse",value:function(response){if(response.access_token){var now=parseInt((Date.now()/1e3).toString());response.expires_at=now+parseInt(response.expires_in)}return new Token(response)}},{key:"fromJSON",value:function(json){if(json)try{var obj=JSON.parse(json);return new Token(obj)}catch(e){}return new Token(null)}}]),Token}(),$__export("Token",Token)}}}),System.register("src/TokenManager.ts",["npm:systemjs-plugin-babel@0.0.6/babel-helpers/classCallCheck.js","npm:systemjs-plugin-babel@0.0.6/babel-helpers/createClass.js","./FrameLoader","./Utils","./OidcClient","./Token"],function($__export){"use strict";var _classCallCheck,_createClass,FrameLoader,Utils,OidcClient,Token,TokenManager;return{setters:[function($__m){_classCallCheck=$__m["default"]},function($__m){_createClass=$__m["default"]},function($__m){FrameLoader=$__m.FrameLoader},function($__m){Utils=$__m.Utils},function($__m){OidcClient=$__m.OidcClient},function($__m){Token=$__m.Token}],execute:function(){TokenManager=function(){function TokenManager(settings){var _this=this;_classCallCheck(this,TokenManager),this._settings=settings||{},"undefined"==typeof this._settings.persist&&(this._settings.persist=!0),this._settings.store=this._settings.store||window.localStorage,this._settings.persistKey=this._settings.persistKey||"TokenManager.token",this.oidcClient=new OidcClient(this._settings),this._callbacks={tokenRemovedCallbacks:[],tokenExpiringCallbacks:[],tokenExpiredCallbacks:[],tokenObtainedCallbacks:[],silentTokenRenewFailedCallbacks:[]},this.loadToken(this),this._settings.store instanceof window.localStorage.constructor&&window.addEventListener("storage",function(e){e.key===_this._settings.persistKey&&(_this.loadToken(_this),_this._token?_this._callTokenObtained():_this._callTokenRemoved())}),this.configureTokenExpired(this),this.configureAutoRenewToken(this),window.setTimeout(function(){_this.configureTokenExpiring(_this)},0)}return _createClass(TokenManager,[{key:"configureTokenExpiring",value:function(mgr){function callback(){handle=null,mgr._callTokenExpiring()}function cancel(){handle&&(window.clearTimeout(handle),handle=null)}function setup(duration){handle=window.setTimeout(callback,1e3*duration)}function configure(){if(cancel(),!mgr.expired){var duration=mgr.expires_in;duration>60?setup(duration-60):callback()}}var handle=null;configure(),mgr.addOnTokenObtained(configure),mgr.addOnTokenRemoved(cancel)}},{key:"configureAutoRenewToken",value:function(mgr){mgr._settings.silent_redirect_uri&&mgr._settings.silent_renew&&mgr.addOnTokenExpiring(function(){mgr.renewTokenSilentAsync()["catch"](function(e){mgr._callSilentTokenRenewFailed(),console.error(e&&e.message||"Unknown error")})})}},{key:"configureTokenExpired",value:function(mgr){function callback(){handle=null,mgr._token&&mgr.saveToken(null),mgr._callTokenExpired()}function cancel(){handle&&(window.clearTimeout(handle),handle=null)}function setup(duration){handle=window.setTimeout(callback,1e3*duration)}function configure(){cancel(),mgr.expires_in>0&&setup(mgr.expires_in+1)}var handle=null;configure(),mgr.addOnTokenObtained(configure),mgr.addOnTokenRemoved(cancel)}},{key:"loadToken",value:function(mgr){if(mgr._token=null,mgr._settings.persist){var tokenJson=mgr._settings.store.getItem(mgr._settings.persistKey);if(tokenJson){var token=Token.fromJSON(tokenJson);token.expired||(mgr._token=token)}}}},{key:"_callTokenRemoved",value:function(){this._callbacks.tokenObtainedCallbacks.forEach(function(cb){return cb()})}},{key:"_callTokenExpiring",value:function(){this._callbacks.tokenExpiringCallbacks.forEach(function(cb){return cb()})}},{key:"_callTokenExpired",value:function(){this._callbacks.tokenExpiredCallbacks.forEach(function(cb){return cb()})}},{key:"_callTokenObtained",value:function(){this._callbacks.tokenObtainedCallbacks.forEach(function(cb){return cb()})}},{key:"_callSilentTokenRenewFailed",value:function(){this._callbacks.silentTokenRenewFailedCallbacks.forEach(function(cb){return cb()})}},{key:"saveToken",value:function(token){!token||token instanceof Token||(token=Token.fromResponse(token)),this._token=token,this._settings.persist&&!this.expired?this._settings.store.setItem(this._settings.persistKey,token.toJSON()):this._settings.store.removeItem(this._settings.persistKey),token?this._callTokenObtained():this._callTokenRemoved()}},{key:"addOnTokenRemoved",value:function(cb){this._callbacks.tokenRemovedCallbacks.push(cb)}},{key:"addOnTokenObtained",value:function(cb){this._callbacks.tokenObtainedCallbacks.push(cb)}},{key:"addOnTokenExpiring",value:function(cb){this._callbacks.tokenRemovedCallbacks.push(cb)}},{key:"addOnTokenExpired",value:function(cb){this._callbacks.tokenExpiredCallbacks.push(cb)}},{key:"addOnSilentTokenRenewFailed",value:function(cb){this._callbacks.silentTokenRenewFailedCallbacks.push(cb)}},{key:"removeToken",value:function(){this.saveToken(null)}},{key:"redirectForToken",value:function(){return this.oidcClient.createTokenRequestAsync().then(function(request){window.location=request.url})["catch"](function(err){return console.error("TokenManager.redirectForToken error: "+(err&&err.message||"Unknown error")),Promise.reject(err)})}},{key:"redirectForLogout",value:function(){var _this2=this;return this.oidcClient.createLogoutRequestAsync(this.id_token).then(function(url){_this2.removeToken(),window.location=url})["catch"](function(err){return console.error("TokenManager.redirectForLogout error: "+(err&&err.message||"Unknown error")),Promise.reject(err)})}},{key:"processTokenCallbackAsync",value:function(queryString){var _this3=this;return this.oidcClient.processResponseAsync(queryString).then(function(token){return _this3.saveToken(token)})}},{key:"renewTokenSilentAsync",value:function(){var _this4=this;if(!this._settings.silent_redirect_uri)return Promise.reject(new Error("silent_redirect_uri not configured"));var settings=Utils.copy(this._settings);settings.redirect_uri=settings.silent_redirect_uri,settings.prompt||(settings.prompt="none");var oidc=new OidcClient(settings);return oidc.createTokenRequestAsync().then(function(request){var frame=new FrameLoader(request.url,{cancelDelay:_this4._settings.silent_renew_timeout});return frame.loadAsync().then(function(hash){return oidc.processResponseAsync(hash).then(function(token){return _this4.saveToken(token)})})})}},{key:"processTokenCallbackSilent",value:function(hash){if(window.parent&&window!==window.parent){var hash=hash||window.location.hash;hash&&window.parent.postMessage(hash,location.protocol+"//"+location.host)}}},{key:"openPopupForTokenAsync",value:function(popupSettings){function checkClosed(){popup.window||(cleanup(),reject_popup(Error("Popup closed")))}popupSettings=popupSettings||{},popupSettings.features=popupSettings.features||"location=no,toolbar=no",popupSettings.target=popupSettings.target||"_blank";var callback_prefix="tokenmgr_callback_";window.openPopupForTokenAsyncCallback||(window.openPopupForTokenAsyncCallback=function(hash){var result=OidcClient.parseOidcResult(hash);result&&result.state&&window[callback_prefix+result.state]&&window[callback_prefix+result.state](hash)});var mgr=this,settings=Utils.copy(this._settings);if(settings.redirect_uri=settings.popup_redirect_uri||settings.redirect_uri,this._pendingPopup)return new Promise(function(resolve,reject){reject(Error("Already a pending popup token request."))});var popup=window.open(settings.redirect_uri,popupSettings.target,popupSettings.features);if(!popup)return new Promise(function(resolve,reject){reject(Error("Error opening popup."))});this._pendingPopup=!0;var reject_popup,cleanup=function(name){handle&&window.clearInterval(handle),popup.close(),delete mgr._pendingPopup,name&&delete window[name]},handle=window.setInterval(checkClosed,1e3);return new Promise(function(resolve,reject){reject_popup=reject;var oidc=new OidcClient(settings);oidc.createTokenRequestAsync().then(function(request){function redirectPopup(){popup.setUrl?popup.setUrl(request.url):total_times>count?(count++,window.setTimeout(redirectPopup,interval)):(cleanup(callback_name),reject(Error("Timeout error on popup")))}var callback_name=callback_prefix+request.request_state.state;window[callback_name]=function(hash){cleanup(callback_name),oidc.processResponseAsync(hash).then(function(token){mgr.saveToken(token),resolve()})["catch"](function(err){return reject(err)})};var seconds_to_wait=5,interval=500,total_times=1e3*seconds_to_wait/interval,count=0;redirectPopup()})["catch"](function(err){cleanup(),reject(err)})})}},{key:"processTokenPopup",value:function(hash){hash=hash||window.location.hash,window.setUrl=function(url){window.location=url},hash&&window.opener.openPopupForTokenAsyncCallback(hash)}},{key:"profile",get:function(){return this._token?this._token.profile:void 0}},{key:"id_token",get:function(){return this._token?this._token.id_token:void 0}},{key:"access_token",get:function(){return this._token&&!this._token.expired?this._token.access_token:void 0}},{key:"expired",get:function(){return this._token?this._token.expired:!0}},{key:"expires_in",get:function(){return this._token?this._token.expires_in:0}},{key:"expires_at",get:function(){return this._token?this._token.expires_at:0}},{key:"scope",get:function(){return this._token&&this._token.scope}},{key:"scopes",get:function(){return this._token?[].concat(this._token.scopes):[]}},{key:"session_state",get:function(){return this._token?this._token.session_state:void 0}}],[{key:"setHttpRequest",value:function(httpRequest){if("object"!=typeof httpRequest||"function"!=typeof httpRequest.getJSON)throw Error("The provided value is not a valid http request.");this._httpRequest=httpRequest}}]),TokenManager}(),$__export("TokenManager",TokenManager)}}}),System.register("src/index.ts",["./TokenManager"],function($__export){"use strict";var TokenManager;return{setters:[function($__m){TokenManager=$__m.TokenManager}],execute:function(){$__export("TokenManager",TokenManager)}}});
//# sourceMappingURL=oidc-token-manager.bundled.js.map