!function(a,b){"object"==typeof exports&&"undefined"!=typeof module?b(exports):"function"==typeof define&&define.amd?define(["exports"],b):b(a.IdentityModel=a.IdentityModel||{})}(this,function(a){"use strict";function b(a,b){for(var c=0;c<b.length;c++){var d=b[c];d.enumerable=d.enumerable||!1,d.configurable=!0,"value"in d&&(d.writable=!0),Object.defineProperty(a,d.key,d)}}function c(a,c,d){return c&&b(a.prototype,c),d&&b(a,d),a}var d=function(a,b){if(!(a instanceof b))throw new TypeError("Cannot call a class as a function")},e=function(){function a(b,c){d(this,a),this.url=b,this.config=c||{},this.config.cancelDelay=this.config.cancelDelay||5e3}return c(a,[{key:"loadAsync",value:function(a){var b=this;return a=a||this.url,a?new Promise(function(c,d){var e=window.document.createElement("iframe");e.style.display="none";var f=window.setTimeout(h,b.config.cancelDelay);window.addEventListener("message",i,!1),window.document.body.appendChild(e),e.src=a;var g=function(){window.removeEventListener("message",i,!1),f&&window.clearTimeout(f),f=null,window.document.body.removeChild(e)},h=function(a){g(),d()},i=function(a){f&&a.origin===location.protocol+"//"+location.host&&a.source==e.contentWindow&&(g(),c(a.data))}}):Promise.reject(new Error("no url provided"))}}]),a}(),f=function(){function a(){d(this,a)}return c(a,null,[{key:"copy",value:function(a,b){b=b||{};for(var c in a)a.hasOwnProperty(c)&&(b[c]=a[c]);return b}}]),a}(),g=function(){function a(b){d(this,a)}return c(a,[{key:"createTokenRequestAsync",value:function(){return Promise.resolve()}},{key:"createLogoutRequestAsync",value:function(a){return Promise.resolve()}},{key:"processResponseAsync",value:function(a){return Promise.resolve()}}],[{key:"parseOidcResult",value:function(a){return a}}]),a}(),h=function(){function a(b){if(d(this,a),this.other=b,this.other||(this.expires_at=0),this.profile=b.profile,this.id_token=b.id_token,this.access_token=b.access_token,b.access_token)this.expires_at=parseInt(b.expires_at);else{if(!b.id_token)throw Error("Either access_token or id_token required.");this.expires_at=b.profile.exp}this.scope=b.scope,this.session_state=b.session_state}return c(a,[{key:"toJSON",value:function(){return JSON.stringify({profile:this.profile,id_token:this.id_token,access_token:this.access_token,expires_at:this.expires_at,scope:this.scopes.join(" "),session_state:this.session_state})}},{key:"scopes",get:function(){return(this.scope||"").split(" ")}},{key:"expired",get:function(){var a=Date.now()/1e3,b=parseInt(a.toString());return this.expires_at<b}},{key:"expires_in",get:function(){var a=Date.now()/1e3,b=parseInt(a.toString());return this.expires_at-b}}],[{key:"fromResponse",value:function(b){if(b.access_token){var c=parseInt((Date.now()/1e3).toString());b.expires_at=c+parseInt(b.expires_in)}return new a(b)}},{key:"fromJSON",value:function(b){if(b)try{var c=JSON.parse(b);return new a(c)}catch(d){}return new a(null)}}]),a}(),i=function(){function a(b){var c=this;d(this,a),this._settings=b||{},"undefined"==typeof this._settings.persist&&(this._settings.persist=!0),this._settings.store=this._settings.store||window.localStorage,this._settings.persistKey=this._settings.persistKey||"TokenManager.token",this.oidcClient=new g(this._settings),this._callbacks={tokenRemovedCallbacks:[],tokenExpiringCallbacks:[],tokenExpiredCallbacks:[],tokenObtainedCallbacks:[],silentTokenRenewFailedCallbacks:[]},this.loadToken(this),this._settings.store instanceof window.localStorage.constructor&&window.addEventListener("storage",function(a){a.key===c._settings.persistKey&&(c.loadToken(c),c._token?c._callTokenObtained():c._callTokenRemoved())}),this.configureTokenExpired(this),this.configureAutoRenewToken(this),window.setTimeout(function(){c.configureTokenExpiring(c)},0)}return c(a,[{key:"configureTokenExpiring",value:function(a){function b(){f=null,a._callTokenExpiring()}function c(){f&&(window.clearTimeout(f),f=null)}function d(a){f=window.setTimeout(b,1e3*a)}function e(){if(c(),!a.expired){var e=a.expires_in;e>60?d(e-60):b()}}var f=null;e(),a.addOnTokenObtained(e),a.addOnTokenRemoved(c)}},{key:"configureAutoRenewToken",value:function(a){a._settings.silent_redirect_uri&&a._settings.silent_renew&&a.addOnTokenExpiring(function(){a.renewTokenSilentAsync()["catch"](function(b){a._callSilentTokenRenewFailed(),console.error(b&&b.message||"Unknown error")})})}},{key:"configureTokenExpired",value:function(a){function b(){f=null,a._token&&a.saveToken(null),a._callTokenExpired()}function c(){f&&(window.clearTimeout(f),f=null)}function d(a){f=window.setTimeout(b,1e3*a)}function e(){c(),a.expires_in>0&&d(a.expires_in+1)}var f=null;e(),a.addOnTokenObtained(e),a.addOnTokenRemoved(c)}},{key:"loadToken",value:function(a){if(a._token=null,a._settings.persist){var b=a._settings.store.getItem(a._settings.persistKey);if(b){var c=h.fromJSON(b);c.expired||(a._token=c)}}}},{key:"_callTokenRemoved",value:function(){this._callbacks.tokenObtainedCallbacks.forEach(function(a){return a()})}},{key:"_callTokenExpiring",value:function(){this._callbacks.tokenExpiringCallbacks.forEach(function(a){return a()})}},{key:"_callTokenExpired",value:function(){this._callbacks.tokenExpiredCallbacks.forEach(function(a){return a()})}},{key:"_callTokenObtained",value:function(){this._callbacks.tokenObtainedCallbacks.forEach(function(a){return a()})}},{key:"_callSilentTokenRenewFailed",value:function(){this._callbacks.silentTokenRenewFailedCallbacks.forEach(function(a){return a()})}},{key:"saveToken",value:function(a){!a||a instanceof h||(a=h.fromResponse(a)),this._token=a,this._settings.persist&&!this.expired?this._settings.store.setItem(this._settings.persistKey,a.toJSON()):this._settings.store.removeItem(this._settings.persistKey),a?this._callTokenObtained():this._callTokenRemoved()}},{key:"addOnTokenRemoved",value:function(a){this._callbacks.tokenRemovedCallbacks.push(a)}},{key:"addOnTokenObtained",value:function(a){this._callbacks.tokenObtainedCallbacks.push(a)}},{key:"addOnTokenExpiring",value:function(a){this._callbacks.tokenRemovedCallbacks.push(a)}},{key:"addOnTokenExpired",value:function(a){this._callbacks.tokenExpiredCallbacks.push(a)}},{key:"addOnSilentTokenRenewFailed",value:function(a){this._callbacks.silentTokenRenewFailedCallbacks.push(a)}},{key:"removeToken",value:function(){this.saveToken(null)}},{key:"redirectForToken",value:function(){return this.oidcClient.createTokenRequestAsync().then(function(a){window.location=a.url})["catch"](function(a){return console.error("TokenManager.redirectForToken error: "+(a&&a.message||"Unknown error")),Promise.reject(a)})}},{key:"redirectForLogout",value:function(){var a=this;return this.oidcClient.createLogoutRequestAsync(this.id_token).then(function(b){a.removeToken(),window.location=b})["catch"](function(a){return console.error("TokenManager.redirectForLogout error: "+(a&&a.message||"Unknown error")),Promise.reject(a)})}},{key:"processTokenCallbackAsync",value:function(a){var b=this;return this.oidcClient.processResponseAsync(a).then(function(a){return b.saveToken(a)})}},{key:"renewTokenSilentAsync",value:function(){var a=this;if(!this._settings.silent_redirect_uri)return Promise.reject(new Error("silent_redirect_uri not configured"));var b=f.copy(this._settings);b.redirect_uri=b.silent_redirect_uri,b.prompt||(b.prompt="none");var c=new g(b);return c.createTokenRequestAsync().then(function(b){var d=new e(b.url,{cancelDelay:a._settings.silent_renew_timeout});return d.loadAsync().then(function(b){return c.processResponseAsync(b).then(function(b){return a.saveToken(b)})})})}},{key:"processTokenCallbackSilent",value:function(a){if(window.parent&&window!==window.parent){var a=a||window.location.hash;a&&window.parent.postMessage(a,location.protocol+"//"+location.host)}}},{key:"openPopupForTokenAsync",value:function(a){function b(){h.window||(j(),i(Error("Popup closed")))}a=a||{},a.features=a.features||"location=no,toolbar=no",a.target=a.target||"_blank";var c="tokenmgr_callback_";window.openPopupForTokenAsyncCallback||(window.openPopupForTokenAsyncCallback=function(a){var b=g.parseOidcResult(a);b&&b.state&&window[c+b.state]&&window[c+b.state](a)});var d=this,e=f.copy(this._settings);if(e.redirect_uri=e.popup_redirect_uri||e.redirect_uri,this._pendingPopup)return new Promise(function(a,b){b(Error("Already a pending popup token request."))});var h=window.open(e.redirect_uri,a.target,a.features);if(!h)return new Promise(function(a,b){b(Error("Error opening popup."))});this._pendingPopup=!0;var i,j=function(a){k&&window.clearInterval(k),h.close(),delete d._pendingPopup,a&&delete window[a]},k=window.setInterval(b,1e3);return new Promise(function(a,b){i=b;var f=new g(e);f.createTokenRequestAsync().then(function(e){function g(){h.setUrl?h.setUrl(e.url):m>n?(n++,window.setTimeout(g,l)):(j(i),b(Error("Timeout error on popup")))}var i=c+e.request_state.state;window[i]=function(c){j(i),f.processResponseAsync(c).then(function(b){d.saveToken(b),a()})["catch"](function(a){return b(a)})};var k=5,l=500,m=1e3*k/l,n=0;g()})["catch"](function(a){j(),b(a)})})}},{key:"processTokenPopup",value:function(a){a=a||window.location.hash,window.setUrl=function(a){window.location=a},a&&window.opener.openPopupForTokenAsyncCallback(a)}},{key:"profile",get:function(){return this._token?this._token.profile:void 0}},{key:"id_token",get:function(){return this._token?this._token.id_token:void 0}},{key:"access_token",get:function(){return this._token&&!this._token.expired?this._token.access_token:void 0}},{key:"expired",get:function(){return this._token?this._token.expired:!0}},{key:"expires_in",get:function(){return this._token?this._token.expires_in:0}},{key:"expires_at",get:function(){return this._token?this._token.expires_at:0}},{key:"scope",get:function(){return this._token&&this._token.scope}},{key:"scopes",get:function(){return this._token?[].concat(this._token.scopes):[]}},{key:"session_state",get:function(){return this._token?this._token.session_state:void 0}}],[{key:"setHttpRequest",value:function(a){if("object"!=typeof a||"function"!=typeof a.getJSON)throw Error("The provided value is not a valid http request.");this._httpRequest=a}}]),a}();a.OidcTokenManager=i});