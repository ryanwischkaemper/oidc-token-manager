<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml">

<head>
  <title></title>
</head>

<body>
  <div id="message"></div>
  <button id="token">Get Token</button>
  <button id="dialog">Get Token (via dialog)</button>
  <button id="forget">Forget Token</button>
  <button id="signout">Logout of IdentityServer</button>
  <pre id="result"></pre>

  <div>
    <p style="font-size:larger">
      SystemJS is loading this code. From the browser's console, run <span style="font-weight:bold">showModuleRelationships()</span> to see
      a visual layout of this code's heirarchy.
    </p>
  </div>

  <script src="https://code.jquery.com/jquery-2.1.0.min.js"></script>

  <script src="../jspm_packages/system.src.js"></script>
  <script src="../jspm.browser.js"></script>
  <script src="../jspm.config.js"></script>
  <script src="system.yuml.js"></script>

  <script>
    $(function () {

            System.import('src').then(function(result){
              console.log('running');
              console.dir(result);
            var config = {
                authority: "https://localhost:44333/core",
                client_id: "js.tokenmanager",
                redirect_uri: window.location.protocol + "//" + window.location.host + "/callback.html",
                post_logout_redirect_uri: window.location.protocol + "//" + window.location.host + "/index.html",
                response_type: "id_token token",
                scope: "openid profile email read write",
                silent_redirect_uri: window.location.protocol + "//" + window.location.host + "/frame.html",
                popup_redirect_uri: window.location.protocol + "//" + window.location.host + "/popup.html",
                silent_renew: true
            };
            var mgr = new result.OidcTokenManager(config);
            window.mgr = mgr;

            if (!mgr.expired) {
                console.log("Token loaded, expires in: ", mgr.expires_in);
                console.log("profile", mgr.profile);
                console.log("access_token", !!mgr.access_token);
            }
            else {
                console.log("No token loaded");
            }

            mgr.addOnTokenObtained(function () {
                console.log("token obtained, scopes: ", mgr.scopes);
            });
            mgr.addOnTokenRemoved(function () {
                console.log("token removed");
            });
            mgr.addOnTokenExpiring(function () {
                console.log("token is about to expire");
                //mgr.renewTokenSilent();
            });
            mgr.addOnTokenExpired(function () {
                $("#message").text("your session is expired");
                console.log("token expired");
            });

            $("#token").click(function () {
                mgr.redirectForToken();
            });

            $("#dialog").click(function () {
                mgr.openPopupForTokenAsync().then(function () {
                    console.log('popup success');
                }, function (err) {
                    console.log('popup error: ', err);
                });
            });

            $("#forget").click(function () {
                mgr.removeToken();
            });

            $("#signout").click(function () {
                mgr.redirectForLogout();
            });

            function toggleForget() {
                $("#forget").prop("disabled", mgr.expired);
            }
            mgr.addOnTokenObtained(toggleForget);
            mgr.addOnTokenRemoved(toggleForget);
            toggleForget();

             }).catch(function(err){
          console.error('An error occurred while bootstrapping the sample app. ' + err.message);
        });
        });
  </script>
</body>

</html>
